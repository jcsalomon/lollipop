\subject[align] Alignment\TeX\ provides a general alignment mechanism for making tables.\term alignments\par\term tables\par\invent\item halign       Horizontal alignment.\item valign       Vertical alignment.   \item omit       Omit the template for one alignment entry.\item span       Join two adjacent alignment entries.\item multispan       Macro to join a number of adjacent alignment entries.\item tabskip       Amount of glue in between columns (rows)      of an \cs{halign} (\cs{valign}). \item noalign       Specify  vertical (horizontal)      material   to be placed in between rows (columns) of      an \cs{halign} (\cs{valign}).\item cr      Terminate an alignment line.\item crcr       Terminate an alignment line if it has       not already been terminated by~\cs{cr}.\item everycr       Token list inserted after every \cs{cr} or non-redundant       \cs{crcr}.\item centering       Glue register in plain \TeX\ for centring      \cs{eqalign} and \cs{eqalignno}.      Value: \n{0pt plus 1000pt minus 1000pt}\item hideskip      Glue register in plain \TeX\ to make alignment entries invisible.      Value: \n{-1000pt plus 1fill}\item hidewidth      Macro to make preceding or following entry invisible.\inventstop\point Introduction\TeX\ has a sophisticated alignment mechanism, based on templates, with one template entry per column or row.The templates may contain any common elementsof the table entries, and in general they containinstructions for typesetting the entries.\TeX\ first calculates widths (for \cs{halign}) or heights(for \cs{valign}) of all entries;then it typesets the whole alignment using in each column (row)the maximum width (height) of entries in that column (row).\point Horizontal and vertical alignmentThe two alignment commands in \TeX\ are\csterm halign\par\csterm valign\par\disp\cs{halign}\gr{box specification}\lb\gr{alignment material}\rb\dispstop for horizontal alignment of columns, and\disp\cs{valign}\gr{box specification}\lb\gr{alignment material}\rb\dispstop for vertical alignment of rows.\cs{halign} is a \gr{vertical command}, and\cs{valign} is a \gr{horizontal command}.The braces induce a new level of grouping; they can beimplicit.The discussion below will mostly focus on horizontalalignments, but, replacing `column' by `row' and vice versa,it applies to vertical alignments too.\spoint Horizontal alignments: \cs{halign}Horizontal alignments yield a list of horizontal boxes, the rows,\term horizontal alignment\parwhich are placed on the surrounding vertical list.The page builder is exercised after the alignment rows have beenadded to  the vertical list.The value of \cs{prevdepth} that holds before the alignmentis used for the baselineskip of the first row,and after the alignment \cs{prevdepth} is set to a value basedon the last row.Each entry is processed in a group of its own,in restricted horizontal mode.A special type of horizontal alignment exists: the\term display alignment\pardisplay alignments, specified as\disp\n{\$\$}\gr{assignments}\cs{halign}\gr{box specification}\lb\n{...}\rb     \gr{assignments}\n{\$\$}\dispstopSuch an alignment is shifted by \cs{displayindent} (seeChapter~\ref[displaymath]) and surrounded by \cs{abovedisplayskip} and \cs{belowdisplayskip} glue.\spoint Vertical alignments: \cs{valign}Vertical alignments are `rotated' horizontal alignments:\term vertical alignment\parthey are placed on the surrounding horizontal lists,and yield a row of columns. The \cs{spacefactor} valueis treated the same way as the \cs{prevdepth} for horizontalalignments: the value current before the alignment is usedfor the first column, and the value reached after the last columnis used after the alignment. In between columns the \cs{spacefactor}value is~1000.Each entry is in a group of its own, and it is processedin internal vertical mode.\spoint Material between the lines: \cs{noalign}Material that has to be contained in the alignment, but should not be treated as an entry or series of entries,\csterm noalign\parcan be given by \disp\cs{noalign}\gr{filler}\lb\gr{vertical mode material}\rb\dispstop for horizontal alignments, and\disp\cs{noalign}\gr{filler}\lb\gr{horizontal mode material}\rb\dispstop for vertical alignments.Examples are\Ver>\noalign{\hrule}<Rev for drawing a horizontal rulebetween two lines of an \cs{halign},and \Ver>\noalign{\penalty100}<Revfor discouraging a page break (or line break) inbetween two rows (columns) of an \cs{halign} (\cs{valign}).\spoint Size of the alignmentThe \gr{box specification} can be used to give the alignmenta predetermined size: for instance\Ver>\halign to \hsize{ ... }<RevGlue contained in the entries of the alignment has no role in this;any stretch orshrink required is taken from the \cs{tabskip} glue.This is explained below.\point The preambleEach line in an alignment is terminated by \cs{cr};the first line is called the {\it template line}.It is of the form\disp\n{$u_1$\#$v_1$\&...\&$u_n$\#$v_n$}\cs{cr}\dispstopwhere each $u_i$, $v_i$ is a (possibly empty) arbitrary sequenceof tokens, and the template entries are separated bythe {\italic alignment tab \term alignment tab\parcharacter} (\n\&~in plain \TeX),that is, any character of category~4. A $u_i$\n\#$v_i$ sequence is the template that will beused for the $i\,$th column: whatever sequence $\alpha_i$the user specifiesas the entry for that column will be inserted at theparameter character. The sequence $u_i\alpha_iv_i$ isthen processed to obtain the actual entry for the $i\,$thcolumn on the current line. See below for more details.The length $n$ of the template line neednot be equal to the actual number of columns in the alignment:the template is used only for as many items as are specifiedon a line. Consider as an example\Ver>\halign{a#&b#&c#\cr 1&2\cr 1\cr}<Revwhich has a three-item template, but the rows have onlyone or two items. The output of this is\disp\leavevmode\vbox{\halign{a#&b#&c#\cr 1&2\cr 1\cr}}\dispstop\spoint Infinite preamblesFor the case where the number of columns is not known in advance,for instance if the alignment is to be used in a macro wherethe user will specify the columns, it is possible tospecify that a trailing piece of thepreamble can be repeated arbitrarily many times.By preceding it with \n\&, an entry can be marked as thestart of this repeatable part of the preamble.See the example of \cs{matrix} below.When the whole preamble is to be repeated, there will bean alignment tab character at the start of the first entry:\Ver>\halign{& ... & ... \cr ... }<RevIf a starting portion of the preamble is to be exempted fromrepetition, a double alignment tab will occur:\Ver>\halign{ ... & ... & ... && ... & ... \cr ... }<RevThe  repeatable part need not be used an integralnumber of times. The alignment rows can end at any time;the rest of the preamble is then not used.\spoint Brace counting in preamblesAlignments may appear inside alignments, so \TeX\ uses thefollowing rule to determine to which alignmentan \n\&  or \cs{cr} control sequence belongs:\disp All tab characters and \cs{cr} tokens of an alignment      should be on the same level of grouping.\dispstopFrom this it follows that tab characters and \cs{cr} tokenscan appear inside an entry if they are nested in braces.This makes it possible to have nested alignments.\spoint Expansion in the preambleAll tokens in the preamble \ldash apart from the tab characters \rdashare stored for insertion in the entries of the alignment,\csterm span\parbut a token preceded by \cs{span} is expanded whilethe preamble is scanned. See below for the function of\cs{span} in the rest of the alignment.\spoint \cs{tabskip}Entries in an alignment are set to take the width of thelargest element in their column.Glue for separating columns can be specified by assigning\csterm tabskip\parto \cs{tabskip}.\altt\TeX\ inserts this glue inbetween each pair of columns, and before the first and after thelast column.The value of \cs{tabskip} that holds outside the alignment isused before the first column, and after all subsequent columns,unless the preamble contains assignments to \cs{tabskip}.Any assignment to \cs{tabskip} is executed while \TeX\ is scanningthe preamble; the value that holds when a tab character isreached will be used at that place in each row, and after all subsequentcolumns, unless further assignments occur.The value of \cs{tabskip} that holds when \cs{cr} is reachedis used after the last column.Assignments to \cs{tabskip} in the preamble are local to thealignment, but not to the entry where they are given.These assignments are ordinary glue assignments:they remove any optional trailing space.As an example, in the following table there is no tabskipglue before the first and after the last column; in between all columns there is stretchable tabskip.\Ver>\tabskip=0pt \halign to \hsize{    \vrule#\tabskip=0pt plus 1fil\strut&     \hfil#\hfil& \vrule#& \hfil#\hfil& \vrule#& \hfil#\hfil&     \tabskip=0pt\vrule#\cr  \noalign{\hrule}    &\multispan5\hfil Just a table\hfil&\cr  \noalign{\hrule}    &one&&two&&three&\cr &a&&b&&c&\cr  \noalign{\hrule}    }<RevThe result of this is\disp\PopListLevel\leavevmode\message{single indent and sufficient vertical}%\hbox{\leftskip0pt \rightskip0pt \vbox{\offinterlineskip\tabskip=0pt \halign to \hsize{\strut    \vrule#\tabskip=0pt plus 1fil\strut&    \hfil#\hfil& \vrule#& \hfil#\hfil&                  \vrule#& \hfil#\hfil&    \tabskip=0pt\vrule#\cr    \noalign{\hrule}    &\multispan5\hfil Just a table\hfil&\cr    \noalign{\hrule}    &one&&two&&three&\cr    &a&&b&&c&\cr    \noalign{\hrule}    }}}\dispstopAll of the vertical rulesof the table are in a separate column. This is the only wayto get the space around the items to stretch.\point The alignmentAfter the template line any number of lines terminated by \cs{cr}can follow. \TeX\ reads all of these lines, processing theentries in order to find the maximal width (height) in each column (row).Because all entries are kept in memory,long tables can overflow \TeX's main memory.For such tables it is better to write a special-purpose macro.\spoint Reading an entryEntries in an alignment are composed of the constant $u$ and $v$ partsof the template, and the variable $\alpha$ part.Basically \TeX\ forms the sequence of tokens $u\alpha v$and processes this. However, there are two special caseswhere \TeX\ has to expand before it forms this sequence.Above, the \cs{noalign} command was described. Since this requires a different treatment from otheralignment entries, \TeX\ expands, after it has read a \cs{cr},the first token of the first $\alpha$ stringof the next line tosee whether that is or expands to \cs{noalign}.Similarly, for all entriesin a line the first token is expanded to seewhether it is or expands to \cs{omit}. This control sequencewill be described below.Entries starting with an \cs{if...} conditional, or a macroexpanding to one, may be misinterpreted owing to thispremature expansion. For example,\Ver>\halign{$#$\cr \ifmmode a\else b\fi\cr}<Revwill give\disp\leavevmode     \vbox{\halign{$#$\cr \ifmmode a\else b\fi\cr}}\dispstopbecause the conditional is evaluated before math mode has been set up.The solution is, as in many other cases, to insert a \cs{relax} control sequence to stop the expansion.Here the \cs{relax} has to be inserted at the start of the alignment entry.If neither \cs{noalign} nor \cs{omit} (see below) is found,\TeX\ will process an input stream composedof  the $u$ part, the $\alpha$ tokens(which are delimited by either \n\& or \cs{span}, see below),and the $v$ part.Entries are delimited by \n\&, \cs{span}, or \cs{cr}, butonly if such a token occurs on the same level of grouping.This makes it possible to have an alignment as an entry ofanother alignment.\spoint Alternate specifications: \cs{omit}The template line will rarely be sufficient to describeall lines of the alignment. For lines where items should be\csterm omit\parset differently the command \cs{omit} exists:if the first token in an entry is (or expands to) \cs{omit}the trivial template \n\# is used instead ofwhat the template line specifies.\example The following alignment uses the same template forall columns, but in the second column an \cs{omit} commandis given.\Ver>\tabskip=1em\halign{&$<#>$\cr a&\omit (b)&c \cr}<RevThe output of this is\disp\leavevmode\vbox{\tabskip=1em\halign{&$<#>$\cr a&\omit (b)&c \cr}}\dispstop\>\spoint Spanning across multiple columns: \cs{span}Sometimes it is desirable to have material spanning severalcolumns. The most obvious example is that of a heading abovea table. For this \TeX\ provides the \cs{span} command.Entries are delimited either by \n\&, by \cs{cr}, or by \cs{span}.\csterm span\parIn the last case \TeX\ will omit the tabskip glue thatwould normally follow the entry thus delimited, andit will typeset the material just read plus the followingentry in the joint space available.As an example,\Ver>\tabskip=1em\halign{&#\cr a&b&c&d\cr a&\hrulefill\span\hrulefill&d\cr}<Revgives\disp\leavevmode\vbox{\tabskip=1em\halign{&#\cr a&b&c&d\cr a&\hrulefill\span\hrulefill&d\cr}}\dispstop Note that there is no tabskip glue in between thetwo spanned columns, but there is tabskip glue before the\altfirst column and after the last.Using the \cs{omit} command this same alignment couldhave been generated as\Ver>\halign{&#\cr a&b&c&d\cr a&\hrulefill\span\omit&d\cr}<RevThe \cs{span}\cs{omit} combination is used in theplain \TeX\ macro\cs{multispan}: for instance\disp\cs{multispan4}\quad gives\quad \ver>\omit\span\omit\span\omit\span\omit>\dispstop which spans across three tabs, and removes the templatesof four entries. Repeating the above example once again:\Ver>\halign{&#\cr a&b&c&d\cr a&\multispan2\hrulefill&d\cr}<RevThe argument of \cs{multispan} is a single token,not a number,so in order to span more than 9 columns the argumentshould be enclosed in braces, for instance \ver>\multispan{12}>.\altFurthermore, a space after a single-digit argumentwill wind up in the output.For a `low budget' solution to spanning columns plain \TeX\ has the\csterm hidewidth\parmacro \cs{hidewidth}, defined by \Ver>\newskip\hideskip \hideskip=-1000pt plus 1fill \def\hidewidth{\hskip\hideskip}<RevPutting \cs{hidewidth} at the beginning or end of an alignment entrywill make its width zero, with the material in the entrysticking out to the left or right respectively.\spoint Rules in alignmentsHorizontal rules inside a horizontal alignment will mostly\term rules in alignments\par\howto Draw rules in an alignment\parbe across the width of the alignment. The easiest wayto attain this is to use \Ver>\noalign{\hrule}<Revlines inside the alignment. If the alignment is containedin a vertical box, lines above and below the alignmentcan be specified with\Ver>\vbox{\hrule \halign{...} \hrule}<RevThe most general way to get horizontal lines in an alignmentis to use\csterm multispan\par\disp\cs{multispan}$\,n$\cs{hrulefill}\dispstopwhich can be used to underline arbitrary adjacent columns.Vertical rules in alignments take some more care.Since a horizontal alignment breaks up intohorizontal boxes that will be placed on a vertical list,\TeX\ will insert baselineskip glue in between the rowsof the alignment. If vertical rules in adjacent rowsare to abut, it is necessary to prevent baselineskip glue,for instance by the \cs{offinterlineskip} macro.In order to ensure that rows will still be properly spacedit is then necessary to place a {\italic strut\/}somewhere in the preamble.A~strut is an invisible object with a certain heightand depth. Putting that in the preamble guarantees thatevery line will have at least that height and depth.In the plain format \cs{strut}\csterm strut\par\ isdefined statically as\Ver>\vrule height8.5pt depth3.5pt width0pt<Revso this must be changed when other fonts or sizes are used.It is a good idea to use a whole column for a~verticalrule, that is, to write\Ver>\vrule#&<Rev in the preamble andto leave the corresponding entry in the alignment empty.Omitting the vertical rule can then be done by specifying \cs{omit},and the size of the rule can be specified explicitly byputting, for instance,\hbox{\n{height 15pt}} in the entry instead of leavingit empty. Of course, tabskip glue will now be specified to theleft and right of the rule, so some extra tabskip assignmentsmay be needed in the preamble.\spoint End of a line: \cs{cr} and \cs{crcr}All lines in an alignment are terminated by the \cs{cr} control \csterm cr\parsequence, including the last line. \TeX\ is not  able to infer froma closing brace in the $\alpha$~part that thealignment has ended, because an unmatchedclosing brace is perfectly valid inan alignment entry;  it may match an opening brace inthe $u$~part of the corresponding preamble entry.\TeX\ has a primitive command \cs{crcr} that is equivalent\csterm crcr\parto \cs{cr}, but it has no effect if it immediately followsa~\cs{cr}.Consider as an example the definition in plain \TeX\of \cs{cases}:\csterm cases\par\Ver>\def\cases#1{%    \left\{\,\vcenter{\normalbaselines\m@th              \ialign{ $##\hfil$& \quad##\hfil \crcr #1\crcr}}%    \right.}<RevBecause of the \cs{crcr} after the user argument \ver.#1.,the following two applications of this macro\disp\ver>\cases{1&2\cr 3&4}>\quad and\quad \ver>\cases{1&2\cr 3&4\cr}>\>both work. In the first case the \cs{crcr} in the macrodefinition ends the last line;in the second case the user's \cs{cr} ends the line,and the \cs{crcr} is redundant.After \cs{cr} and after a non-redundant \cs{crcr} the\gr{token parameter} \cs{everycr} is inserted.\csterm everycr\parThis includes the \cs{cr} terminating the template line.\point Example: math alignmentsThe plain format has several alignment macros that functionin math mode. One example is \cs{matrix}, defined by\csterm matrix\par\Ver>\def\matrix#1{\null\,\vcenter{\normalbaselines\m@th    \ialign{\hfil$##$\hfil && \quad\hfil$##$\hfil\crcr            \mathstrut\crcr         \noalign{\kern-\baselineskip}            #1\crcr            \mathstrut\crcr         \noalign{\kern-\baselineskip}}}\,}<RevThis uses a repeating (starting with~\ver>&&>) second preamble entry;each entry is centred by an \cs{hfil} before and after it,and there is a \cs{quad} of space in between columns.Tabskip glue was not used for this, because there should notbe any glue preceding or following the matrix.The combination of a \cs{mathstrut} and \ver>\kern-\baselineskip>above and below the matrix increases the vertical sizesuch that two matrices with the same number of rows will havethe same height and depth, which would not otherwise be the caseif one of them had subscripts in the last row, but the othernot. The \cs{mathstrut} causes interline glue to be inserted and, because it has a size equal to \cs{baselineskip},the negative kern will effectively leave only the interline glue,thereby buffering any differences in the first and last line.Only to a certain point, of course: objects bigger than theopening brace will still result in a different height or depth of the matrix.Another, morecomplicated, example of an alignment for math mode is \cs{eq\-alignno}.\csterm eqalignno\par\csterm centering\par\Ver>\def\eqalignno#1{\displ@y \tabskip\centering  \halign to\displaywidth{    \hfil$\@lign\displaystyle{##}$%    -- first column        \tabskip\z@skip    &$\@lign\displaystyle{{}##}$\hfil% -- second column        \tabskip\centering    &\llap{$\@lign##$}%                -- third column        \tabskip\z@skip\crcr   %   end of the preamble       #1\crcr}}<RevFirstly, the tabskip is set to zero after the equationnumber, so this number is set flush with the right margin.Since it is placed by \cs{llap}, its effective widthis zero. Secondly, the tabskip between thefirst and second columns is also zero, and the tabskipbefore the first column and after the second  is\alt\cs{centering}, which is \n{0pt plus 1000pt minus 1000pt},so the first column and second  are jointly centredin the \cs{hsize}. Note that, because of the\n{minus 1000pt}, these two columns will happily gooutside the left and right margins, overwriting anyequation numbers.\endinput\spoint Error messages\aftergroup in alignment?