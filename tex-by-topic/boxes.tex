%\tracingmacros=2 \tracingcommands\tracingmacros\subject[boxes] BoxesThe horizontal and vertical boxes of \TeX\ are containers for\term boxes\parpieces of horizontal and vertical lists.Boxes can be stored in box registers. This chapter treats box registers and suchaspects of boxes as their dimensions, and the way their componentsare placed relative to each other.\invent\item hbox       Construct a horizontal box.\item vbox       Construct a vertical box with reference point of the last item.\item vtop       Construct a vertical box with reference point of the first item.\item vcenter       Construct a vertical box vertically centred      on the math axis; this command can only be used in math mode.\item vsplit       Split off the top part of a vertical box. \item box       Use a box register, emptying it. \item setbox       Assign a box to a box register.\item copy       Use a box register, but retain the contents. \item ifhbox \cs{ifvbox}      Test whether a box register contains a horizontal/""vertical box.\item ifvoid       Test whether a box register is empty.\item newbox       Allocate a new box register. \item unhbox \cs{unvbox}      Unpack a box register containing a horizontal/vertical box,      adding the contents to the current horizontal/vertical list,      and emptying the register. \item unhcopy \cs{unvcopy}      The same as \cs{unhbox}$\,$/$\,$\cs{unvbox},      but do not empty the register. \item ht \cs{dp} \cs{wd}      Height/depth/width of the box in a box register. \item boxmaxdepth       Maximum allowed depth of boxes.      Plain \TeX\ default:~\cs{maxdimen}.\item splitmaxdepth      Maximum allowed depth of boxes generated by \cs{vsplit}.\item badness       Badness of the most recently constructed box.\item hfuzz \cs{vfuzz}      Excess size that \TeX\ tolerates before it considers        a horizontal/""vertical box overfull.\item hbadness \cs{vbadness}      Amount of tolerance before \TeX\ reports an underfull       or overfull  horizontal/""vertical box.\item overfullrule       Width of the rule that is printed to indicate       overfull horizontal boxes. \item hsize       Line width used for text typesetting inside a vertical box.\awp\item vsize       Height of the page box.\item lastbox       Register containing the last item added to the current list,       if this was a box.\item raise \cs{lower}      Adjust vertical positioning of a box in horizontal mode. \item moveleft \cs{moveright}      Adjust horizontal positioning of a box in vertical mode. \item everyhbox \cs{everyvbox}      Token list inserted at the start of a horizontal/""vertical box.\inventstop\point BoxesIn this chapter we shall look at boxes. Boxes are containersfor pieces of horizontal or vertical lists.Boxes that are needed more than once can be stored in box registers.When \TeX\ expects a \gr{box}, any of the following formsis admissible:\itemlist\item \cs{hbox}\gr{box specification}\lb\gr{horizontal material}\rb\item \cs{vbox}\gr{box specification}\lb\gr{vertical material}\rb\item \cs{vtop}\gr{box specification}\lb\gr{vertical material}\rb\item \cs{box}\gr{8-bit number}\item \cs{copy}\gr{8-bit number}\item \cs{vsplit}\gr{8-bit number}\n{to}\gr{dimen}\item \cs{lastbox}\itemliststopA \gr{box specification} is defined as\label[box:spec]\disp\gr{box specification} $\longrightarrow$ \gr{filler}\nl\indent$|$ \n{to} \gr{dimen}\gr{filler}           $|$ \n{spread} \gr{dimen}\gr{filler}\dispstopAn \gr{8-bit number} is a number in the range~0--255.The braces surrounding box material define a group;they can be explicit charactersof categories 1 and~2 respectively,or control sequences \cs{let} to such characters;see also below.A \gr{box} can in general be used in horizontal, vertical,and math mode, but see below for the \cs{lastbox}.The connection betweenboxes and modes is explored further in Chapter~\ref[hvmode].The box produced by \cs{vcenter} \ldash a command that is allowed only inmath mode \rdash  is not a \gr{box}. For instance,it can not be assigned with \ver=\setbox=; see furtherChapter~\ref[math].The \cs{vsplit} operation is treated in Chapter~\ref[page:break].\point Box registersThere are 256 box registers, numbered 0--255. \term box registers\parEither a box register is  empty (`void'), or it contains a horizontalor vertical box.This section discusses specifically box {\em registers};the sizes of boxes, and the way material is arranged inside them,is treated below.\awp\spoint Allocation: \cs{newbox}The plain \TeX\ \cs{newbox} macro allocates an unused\csterm newbox\parbox register:\Ver>\newbox\MyBox <Revafter which one can say\Ver>\setbox\MyBox=...<Rev or \Ver>\box\MyBox<Rev and so on.Subsequent calls to this macro give subsequent box numbers;this way macro collections can allocate their own boxeswithout fear of collision with other macros.The number of the box is assigned by \cs{chardef}(see Chapter~\ref[alloc]). This implies that \cs{MyBox} is equivalent to,and can be used as, a~\gr{number}.The control sequence\altt\cs{newbox} is an \cs{outer} macro.Newly allocated box registers are initially empty.\spoint Usage: \cs{setbox}, \cs{box}, \cs{copy}A~register is filled by assigning a \gr{box}\csterm setbox\parto it:\Disp\ver>\setbox>\gr{number}\gr{equals}\gr{box}\DispstopFor example, the \gr{box} can be explicit\Disp\ver>\setbox37=\hbox{...}>\quad or\quad \ver>\setbox37=\vbox{...}>\Dispstopor it can be a box register:\Ver>\setbox37=\box38<RevUsually, box numbers will have been assigned by a \cs{newbox}command.The box in a box register is appendedby the commands \cs{box} and~\cs{copy}to whatever list \TeX\ is building: the call\Ver>\box38<Rev appends box~38.To save memory space, box registers become empty by using them:\csterm box\par\csterm copy\par\TeX\ assumes that after you have inserted a box bycalling \cs{box}$nn$ in some mode, you do not need thecontents of that register any more and empties it.In case you {\em do\/} need the contents ofa box register more than once, you can \cs{copy} it. Calling \cs{copy}$nn$ isequivalent to \cs{box}$nn$ in all respects except thatthe register is not cleared.It is possible to unwrap the contents of a box registerby `unboxing' it using the commands \cs{unhbox} and \cs{unvbox},and their copying versions \cs{unhcopy} and \cs{unvcopy}.Whereas a box can be used in any mode, theunboxing operations can only be used in the appropriate mode,since in effect they contribute a partialhorizontal or vertical list (see also Chapter~\ref[hvmode]).See below for more information on unboxing registers.\awp\spoint Testing: \cs{ifvoid}, \cs{ifhbox}, \cs{ifvbox}Boxregisters can be tested for their contents:\disp\cs{ifvoid}\gr{number}\dispstopis true if the box register is empty.Note that an empty, or `void',box register is not the same as a register containing an empty box.An empty box is still either a horizontal or a vertical box;a~void register can be used as both.The test\disp\cs{ifhbox}\gr{number}\dispstopis true if the box register contains a horizontal box;\disp\cs{ifvbox}\gr{number}\dispstopis true if the box register contains a vertical box.Both tests are false for void registers.\spoint[lastbox] The \cs{lastbox}When \TeX\ has built a partial list, the last box in this\csterm lastbox\parlist is accessible as the \cs{lastbox}. This behaveslike a box register, so you can remove the last box from  thelist by assigning the \cs{lastbox} to some  box register. If the last item on the current list is not a box,the \cs{lastbox} acts like a void box register.It is not possible to get hold of the last boxin the case of the main vertical list.The \cs{lastbox} is then always void.As an example, the statement \Ver>{\setbox0=\lastbox}<Rev removesthe last box from the current list, assigning it to boxregister~0. Since this assignment occurs inside a group,the register is cleared at the end of the group.At the start of a paragraph this can be used to remove theindentation box (see Chapter~\ref[par:start]).Another example of \cs{lastbox} can be found on page~\pgref[varioset].Because the \ver-\lastbox- is always empty in external vertical mode,it is not possible to get hold of boxes that have been added to the page. However, it is possible to dissectthe page once it is in \cs{box255}, for instance doing\Ver>\vbox{\unvbox255{\setbox0=\lastbox}}<Revinside the output routine.If boxes in vertical mode have been shifted by \cs{moveright}or \cs{moveleft}, or if boxes in horizontal mode  havebeen raised by \cs{raise} or lowered by \cs{lower}, any information about thisdisplacement due to such a command is lost whenthe \cs{lastbox} is taken from the list.\awp\point Natural dimensions of boxes\spoint Dimensions of created horizontal boxesInside an \cs{hbox} all constituents are lined up next to each other,\term box dimensions\par\csterm hbox\parwith their reference points on the baseline of the box,unless they are moved explicitly in the vertical directionby \cs{lower} or~\cs{raise}.The resulting width of the box is the sum of the widthsof the components. Thus the width of\Ver>\hbox{\hskip1cm}<Rev is positive, and the width of\Ver>\hbox{\hskip-1cm}<Revis negative. By way of example,\disp\ver>a\hbox{\kern-1em b}--> \>gives as output\disp\leavevmode\hphantom{b}a\hbox{\kern-1em b}--\>\message{check align input/output}which shows that a horizontal box can have negativewidth.The height and depth of an \cs{hbox} are themaximum amount that constituent boxes project above andbelow the baseline of the box. They are non-negative when thebox is created.The commands \cs{lower} and \cs{raise} are the only possibilitiesfor vertical movement inside an \cs{hbox} (other thanincluding a \cs{vbox} inside the \cs{hbox}, of course);a~\gr{vertical command} \ldash such as \cs{vskip} \rdash is not allowed in a horizontal box, and\cs{par}, although allowed,does not do anything inside a horizontal box.\spoint Dimensions of created vertical boxesInside a \cs{vbox} vertical material is lined up with the\csterm vbox\par\csterm vtop\parreference points on the vertical line through the referencepoint of the box,unless components are moved explicitly in the horizontal directionby \cs{moveleft} or~\cs{moveright}.The  reference point of a vertical boxis always located at the left boundary of the box.The width of a vertical boxis then the maximal amount that any material in thebox sticks to the right of the reference point.Material to the left of the reference point isnot taken into account in the width.Thus the result of\disp\ver>a\vbox{\hbox{\kern-1em b}}-->\>is\disp\leavevmode\hphantom{b}a\vbox{\hbox{\kern-1em b}}--\>This should be contrasted with the above example.The calculation of height and depth is differentfor vertical boxes constructed by \cs{vbox} and \cs{vtop}.The ground rule is that\awpa \cs{vbox} has a reference point that lies onthe baseline of its last component,and a \cs{vtop} has its reference point on the baseline of thefirst component.In general, the depth (height) of a \cs{vbox} (\cs{vtop})\altcan be non-zero if the last (first) item is a box or rule.The height of a \cs{vbox} is then the sum of the heights anddepths of all components except the last, plus the heightof that last component; the depth of the \cs{vbox} is thedepth of its last component.The depth of a \cs{vtop}is the sum of the depth of the first component and the heightsand depths of all subsequent material; its height is theheight of the first component.However, the actual rules are a bitmore complicated when the first component of a \cs{vtop}or the last component of a \cs{vbox} is not a box or rule.If the last component of a \cs{vbox} is a kern or a glue,the depth of that box is zero; a \cs{vtop}'s height is zerounless its first component is a box or rule.\altt(Note the asymmetry in these definitions; see below foran example illustrating this.)The depth of a \cs{vtop}, then, is equal to the totalheight plus depth of all enclosed material minusthe height of the \cs{vtop}.There is a limit on the depth of vertical boxes:if the depth of a \cs{vbox} or \cs{vtop}calculated by the above rules would exceed\cstoidx boxmaxdepth\par,the reference point of the boxis moved down by the excess amount. More precisely, the excess depth is added to the natural height of the box. If the box had a \n{to} or\n{spread} specification, any glue is set anew to takethe new height into account.Ordinarily,\cs{boxmaxdepth} is set to the maximum dimensionpossible in \TeX. It is for instance reduced during some ofthe calculations  in the plain \TeX\ output routine;see Chapter~\ref[output].\spoint ExamplesHorizontal boxes are relatively straightforward. Their width is thedistance between the `beginning' and the `end' of thebox, and consequently the width is not necessarily positive.With\Ver>\setbox0=\hbox{aa} \setbox1=\hbox{\copy0 \hskip-\wd0}<Revthe \cs{box1} has width zero;\Disp \ver-/\box1/-\quad gives\quad`{\setbox0=\hbox{aa}\setbox1=\hbox{\copy0 \hskip-\wd0}/\box1/}\kern.75em'\DispstopThe height and depth of a horizontal box cannot be negative: in\Ver>\setbox0=\hbox{\vrule height 5pt depth 5pt}\setbox1=\hbox{\raise 10pt \box0}<Revthe \cs{box1} has depth \n{0pt} and height~\n{15pt}Vertical boxes are more troublesome than horizontal boxes.Let us first treat their width.After \Ver>\setbox0=\hbox{\hskip 10pt}<Rev the box in the\cs{box0} register has a width of \n{10pt}. Defining\Ver>\setbox1=\vbox{\moveleft 5pt \copy0}<Rev\awpthe \cs{box1} will have width \n{5pt}; material to theleft of the reference point is not accounted for in thewidth of a vertical box. With\Ver>\setbox2=\vbox{\moveright 5pt \copy0}<Revthe \cs{box2} will have width \n{15pt}.The depth of a \cs{vbox} is the depth of the last item ifthat is a box, so\Ver>\vbox{\vskip 5pt \hbox{\vrule height 5pt depth 5pt}}<Revhas height \n{10pt} and depth \n{5pt}, and \Ver>\vbox{\vskip -5pt \hbox{\vrule height 5pt depth 5pt}}<Revhas height \n{0pt} and depth~\n{5pt}.With a glue or kern as the last item in the box, the resulting depthis zero, so \Ver>\vbox{\hbox{\vrule height 5pt depth 5pt}\vskip 5pt}<Revhas height \n{15pt} and depth~\n{0pt};\Ver>\vbox{\hbox{\vrule height 5pt depth 5pt}\vskip -5pt}<Revhas height \n{5pt} and depth~\n{0pt}.The height of a \cs{vtop} behaves (almost) the same with respect tothe first item of the box, as the depth of a \cs{vbox} doeswith respect to the last item. Repeating the above examples witha \cs{vtop} gives the following:\Ver>\vtop{\vskip 5pt \hbox{\vrule height 5pt depth 5pt}}<Revhas height \n{0pt} and depth \n{15pt}, and \Ver>\vtop{\vskip -5pt \hbox{\vrule height 5pt depth 5pt}}<Revhas height \n{0pt} and depth~\n{5pt};\Ver>\vtop{\hbox{\vrule height 5pt depth 5pt} \vskip 5pt}<Revhas height \n{5pt} and depth~\n{10pt}, and\Ver>\vtop{\hbox{\vrule height 5pt depth 5pt} \vskip -5pt}<Revhas height \n{5pt} and depth~\n{0pt}.\point More about box dimensions\spoint Predetermined dimensionsThe size of a box can be specified in advancewith a \gr{box specification}; see above for the syntax.Any gluein the box is then set in order to reach the required size.Prescribing the size of the box is done by\disp\cs{hbox} \n{to} \gr{dimen} \n{\lb...\rb},     \cs{vbox} \n{to} \gr{dimen} \n{\lb...\rb}\dispstop\awpIf stretchable or shrinkable glue is present in the box,it is stretched or shrunk in order to give the box thespecified size. Associated with this glue setting is a badness value(see Chapter~\ref[glue]). If no stretch or shrink \ldash whicheveris necessary \rdash  is present, the resulting box will be underfullor overfull respectively. Error reporting for over/underfullboxes is treated below.Another command to let a box have a size other thanthe natural size is\disp\cs{hbox} \n{spread} \gr{dimen} \n{\lb...\rb},     \cs{vbox} \n{spread} \gr{dimen} \n{\lb...\rb}\dispstopwhich tells \TeX\ to set the glue in such a way thatthe size of the box is a  specified amount more than the natural size.Box specifications for \cs{vtop} vertical boxes aresomewhat difficult to interpret. \TeX\ constructs a \cs{vtop}by first making a \cs{vbox}, including glue settings induced by a \gr{box specification};then it computes the height and depth by the above rules.Glue setting is described in Chapter~\ref[glue].\spoint Changes to box dimensionsThe dimensions of a box register are accessible by the\csterm ht\par\csterm dp\par\csterm  wd\parcommands \cs{ht}, \cs{dp}, and~\cs{wd};for instance \cs{dp13} gives the depth of box~13.However, not only can boxes be measured this way;by assigning values to thesedimensions \TeX\ can even be fooled into thinking thata box has a  size different from its actual.However, changing the dimensions of a box does not changeanything about the contents; in particular it does notchange the way the glue is set.Various formats use this in `smash' macros: the macro defined by\csterm smash\par\Ver>\def\smash#1{{\setbox0=\hbox{#1}\dp0=0pt \ht0=0pt \box0\relax}}<Revplaces its argument but annihilates its height and depth;\alttthat is, the output does show the whole box, but further calculationsby \TeX\ act as if the height and depth were zero.Box dimensions can be changed only by setting them.They are \gr{box dimen}s, which can only be setin a \gr{box size assignment}, and not, for instancechanged with \cs{advance}.Note that a \gr{box size assignment} is a \gr{global assignment}:its effect transcends any groups in which it occurs(see Chapter~\ref[group]).Thus the output of \Ver>\setbox0=\hbox{---} {\wd0=0pt} a\box0b<Revis `{\setbox0=\hbox{---}{\wd0=0pt}a\box0b}\kern.5em'.The limits that hold on the dimensions with which a box can be created (see above) do not hold for explicit changes to thesize of a box: the assignment \cs{dp0=}""\n{-2pt} for a horizontal box is perfectly admissible.\spoint Moving boxes aroundIn a horizontal box all constituent elements are lined up\csterm raise\par\csterm lower\parwith their reference points at the same height as the reference point of the box. Any box inside a horizontalbox can be lifted or dropped using the macros\cs{raise} and~\cs{lower}.\awpSimilarly, in a vertical box all constituent elements\csterm moveleft\par\csterm moveright\parare lined up with their reference points underneath one another,in line with the reference point of the box.Boxes can now be moved sideways by the macros \cs{moveleft} and~\cs{moveright}.Only boxes can be shifted thus; these operations cannot be applied to, for instance, characters or rules.\spoint Box dimensions and box placement\TeX\ places the components of horizontal andvertical lists by maintaining a reference line and acurrent position on that line. For horizontal liststhe reference line is the baseline of the surrounding\cs{hbox}; for vertical lists it is the vertical linethrough the reference point of the surrounding \cs{vbox}.In horizontal mode a component is placed as follows.The current position coincides initiallywith the reference point of the surrounding box. After that,the following actions are carried out.\enumerate \item If the component has been shifted by\cs{raise} or \cs{lower}, shift the currentposition correspondingly.\item If the component is a horizontal box, usethis algorithm recursively for its contents; if it is a vertical box, go up  by the height of this box,putting  a new current position for the enclosed vertical list there,and place its components using the algorithm for verticallists below.\item Move the current position (on the reference line)to the right by the width of the component.\>For the list in a vertical box \TeX's  current position isinitially at the upper left corner of that box, as explained above,and the reference line is the vertical line through that point;it also runs through the reference point of the box.Enclosed components are then placed as follows.\enumerate \item If a component has been shifted using\cs{moveleft} or \cs{moveright}, shift the current positionaccordingly.\item Put the component with its upper left corner at thecurrent position.\item If the component is a vertical box, use this algorithmrecursively for its contents; if it is a horizontal box,its reference point can be found below  the current positionby the height of the box. Put the current position for thatbox there, and use the above algorithm for horizontal lists.\item Go down by the height plus depth of the box(that is, starting at the upper left corner of the box)on the  reference line,and continue processing vertically.\>Note that the above processes do not describe the constructionof boxes. That would (for instance)involve for vertical boxes the insertionof baselineskip glue. Rather, it describes the way the componentsof a finished box are arranged in the output.\spoint Boxes and negative glueSometimes it is useful to have boxes overlapping instead of\awpline up. An easy way to do this is to use negative glue.In horizontal mode\Ver>{\dimen0=\wd8 \box8 \kern-\dimen0}<Revplaces box 8 without moving the current location.More versatile are the macros \cs{llap} and \cs{rlap}\label[rlap],\csterm llap\par\csterm rlap\pardefined as \Ver>\def\llap#1{\hbox to 0pt{\hss #1}}<Revand \Ver>\def\rlap#1{\hbox to 0pt{#1\hss}}<Revthat allow material to protrude left or right from thecurrent location.The \cs{hss} glue is equivalent to \ver>\hskip 0pt plus 1fil minus 1fil>, which absorbs any positive or negative widthof the argument of \cs{llap} or \cs{rlap}.\example The sequence \Ver>\llap{\hbox to 10pt{a\hfil}}<Revis effectively the same as\Ver>\hbox{\hskip-10pt \hbox to 10pt{a\hfil}}<Revwhich has a total width of~\n{0pt}.\>\point[over/underfull] Overfull and underfull boxesIf a box has a  size specification \TeX\ will\term overfull boxes\par\term underfull boxes\parstretch or shrink glue in the box. For glue withonly finite stretch or shrink components the {\em badness\/}(see Chapter~\ref[line:break]) of stretching or shrinkingis computed.In \TeX\ version~3 the badness\csterm badness\par\term \TeX\ version 3\parof the box most recentlyconstructed is available for inspectionby the user through the \cs{badness} parameter. Values forbadness range 0--$10\,000$, but if the box is overfullit is~$1\,000\,000$.When \TeX\ considers the badness too large,it gives a diagnostic message. Let us first consider error reportingfor horizontal boxes.Horizontal boxes of which the glue has to stretch are never reported if\csterm hbadness\par\csterm vbadness\par\cs{hbadness}${}\geq10\,000$; otherwise \TeX\ reports themas `underfull' if their badness is more than \cs{hbadness}.Glue shrinking can lead to `overfull' boxes: a box is called\csterm hfuzz\par\csterm vfuzz\paroverfull if the available shrink is less than the shrinknecessary to meet the box specification. An overfull boxis only reported if the difference in shrink is more than\cs{hfuzz}, or if \cs{hbadness}${}<100$ (and it turns out thatusing all available shrinkability has badness~$100$).\example Setting \ver>\hfuzz=1pt> will let \TeX\ ignoreboxes that can not shrink enough if they lack less than~\n{1pt}.In \Ver>\hbox to 1pt{\hskip3pt minus .5pt}<Rev\awp\Ver>\hbox to 1pt{\hskip3pt minus 1.5pt}<Revonly the first box will give an error message:it is \n{1.5pt} too big, whereas the second lacks\n{.5pt} which is less than \cs{hfuzz}.\>Also, boxes that shrink but that are not overfull can be reported:if a box is `tight', that is, if it uses at least half itsshrinkability, \TeX\ reports this fact if thecomputed badness (which is between 13 and~100) is more than\cs{hbadness}.For horizontal and vertical boxes this error reporting is almost\csterm overfullrule\parthe same, with parameters \cs{vbadness} and \cs{vfuzz}.The difference is that for horizontal overfull boxes\TeX\ will draw a rule to the right of the box that has thesame height as the box, and width \cs{overfullrule}.No overfull rule ensues if the \cs{tabskip} glue in an \cs{halign} cannot beshrunk enough.\point Opening and closing boxesThe opening and closing braces of a box can be either explicit,that is, character tokens of category 1 and~2, or implicit,a control sequence \ver=\let= to such a character.After the opening brace the \ver=\everyhbox= or \cs{everyvbox}\csterm everyhbox\par\csterm everyvbox\partokens are inserted.If this box appeared in a \ver=\setbox= assignmentany \ver=\afterassignment=token is inserted even before the `everybox' tokens.\example \label[every:box:assign]\Ver>\everyhbox{b}\afterassignment a\setbox0=\hbox{c}\showbox0<Rev gives\Ver>> \box0=\hbox(6.94444+0.0)x15.27782.\tenrm a.\tenrm b.\kern0.27779.\tenrm c<Rev\>Implicit braces can be used to let a box be opened or closedby a macro, for example:\Ver>\def\openbox#1{\setbox#1=\hbox\bgroup}\def\closebox#1{\egroup\DoSomethingWithBox#1}\openbox0 ... \closebox0<RevThis mechanism can be used to scoop up paragraphs:\Ver>\everypar{\setbox\parbox=    \vbox\bgroup         \everypar{}         \def\par{\egroup\UseBox\parbox}}<RevHere the \cs{everypar} opens the box and lets the text beset in the box: starting for instance\Ver>Begin a text ...<Revgives the equivalent of\Ver>\setbox\parbox=\vbox{Begin a text ...<RevInside the box \cs{par} has been redefined, so\Ver>... a text ends.\par<Revis equivalent to\Ver>... a text ends.}\Usebox\parbox<RevIn this example, the \cs{UseBox} command can only treat thebox as a whole; if the elements of the box should somehowbe treated separately another approach is necessary.In \Ver>\everypar{\setbox\parbox=  \vbox\bgroup\everypar{}%       \def\par{\endgraf\HandleLines                \egroup\box\parbox}}\def\HandleLines{ ... \lastbox ... }<Revthe macro \cs{HandleLines} can have access to successiveelements from the vertical list of the paragraph.See also the example on page~\pgref[varioset].\point UnboxingBoxes can be unwrapped by the commands \cs{unhbox} and\csterm unhbox\par\csterm unvbox\par\csterm unhcopy\par\csterm unvcopy\par\term unboxing\par\cs{unvbox}, and by their copying versions \cs{unhcopy} and \cs{unvcopy}. These are horizontal and vertical commands(see Chapter~\ref[hvmode]), considering that in effectthey contribute a partial horizontal or vertical list.It is not possible to \cs{unhbox} a registercontaining a \cs{vbox} or vice versa,but a void box register can both be \cs{unhbox}ed and\cs{unvbox}ed.Unboxing takes the contents of a box in a box register and appendsthem to the surrounding list; any glue can then be set anew. Thus\Ver>\setbox0=\hbox to 1cm{\hfil} \hbox to 2cm{\unhbox0}<Revis completely equivalent to \Ver>\hbox to 2cm{\hfil}<Rev and not to\Ver>\hbox to 2cm{\kern1cm}<Rev\awpThe intrinsically horizontal nature of \cs{unhbox} is\csterm leavevmode\parused to define\Ver>\def\leavevmode{\unhbox\voidb@x}<RevThis command switches from vertical mode to horizontal withoutadding anything to the horizontal list. However, the subsequent \cs{indent} caused by this transitionadds an indentation box.In horizontal mode the \cs{leavevmode} command has no effect.Note that here it is not necessary to use \cs{unhcopy},because the register is empty anyhow. Beware of the following subtlety: unboxing in verticalmode does not add interline glue between the box contents andany preceding item. Also, the value of \cs{prevdepth} is notchanged, so glue between the box contents and any followingitem will  occur only if there was something preceding the box;interline glue will be based on the depth of that preceding item.Similarly, unboxing in horizontal mode does not influencethe \cs{spacefactor}.\point Text in boxesBoth horizontal and vertical boxes can contain text. However,\term text in boxes\parthe way text is treated differs. In horizontal boxesthe text is placed in one straight line, and the width ofthe box is in principle the natural width of the text (and other items) contained in it. No \gram{vertical command}sare allowed inside a horizontal box, and \cs{par} doesnothing in this case.For vertical boxes the situation is radically different.As soon as a character, or any other \gram{horizontal command}(see page~\pgref[h:com:list]),is encountered in a vertical box, \TeX\ starts building a paragraphin unrestricted horizontal mode, that is, just as if the paragraphwere directly part of the page.At the occurrence of a \gram{vertical command}(see page~\pgref[v:com:list]), or at the endof the box, the paragraph is broken into lines using thecurrent values of parameters such as~\cs{hsize}.Thus \Ver>\hbox to 3cm{\vbox{some reasonably long text}}<Revwill {\sl not\/} give a paragraph of width 3 centimetres (it gives an overfull horizontal box if \cs{hsize}${}>{}$\n{3cm}).However,\Ver>\vbox{\hsize=3cm some reasonably long text}<Revwill be 3 centimetres wide.A paragraph of text inside a vertical box is broken intolines, which are packed in horizontal boxes.These boxes  are then stackedin internal vertical mode, possibly with\cs{baselineskip} and \cs{lineskip} separating them(this is treated in Chapter~\ref[baseline]).This process is also used for text on the page; the boxesare then stacked in outer vertical mode.If the internal vertical list is empty, no \cs{parskip}glue is added at the start of a paragraph.Because text in a horizontal box is not\label[wide:vbox]%broken into lines, there is a furtherdifference between text in restricted and unrestricted\awphorizontal mode. In restricted horizontal mode nodiscretionary nodes and whatsit items changing thevalue of the current language are inserted.This may give problems if the text is subsequentlyunboxed to form part of a paragraph.See Chapter~\ref[line:break] for an explanation of theseitems, and \cite[Downs] for a way around this problem.\point Assorted remarks\spoint Forgetting the \cs{box}After \ver.\newcount\foo., one can use \cs{foo} on its ownto get the \cs{foo} counter.For  boxes, however, one has to use \ver.\box\foo. to getthe \cs{foo} box.The reason for this is that there existsno separate \cs{boxdef} command, so \cs{chardef} isused (see Chapter~\ref[alloc]). \example Suppose \ver.\newbox\foo. allocates box register~25; thentyping \cs{foo} is equivalent  to typing\ver.\char25..\>\spoint Special-purpose boxesSome   box registers have a specialpurpose:\itemlist\item \cs{box255} is by used \TeX\ internally  to give the page to the output routine.\item \cs{voidb@x} is the number of  a box register allocated in  \n{plain.tex}; it is supposed to be empty always. It is used in the macro \cs{leavevmode} and others.\item when a new \cs{insert} is created with the plain \TeX\ \cs{newinsert} macro, a \cs{count}, \cs{dimen}, \cs{skip}, and \cs{box} all with the same number are reserved for that insert. The numbers for these registers count down from~254.\itemliststop\spoint The height of a vertical box in horizontal modeIn horizontal mode a vertical box is placed with itsreference point aligned vertically with the referencepoint of the surrounding box. \TeX\ then traverses its contents starting at the leftupper corner; that is, the point that lies above the referencepoint by a distance of the height of the box.Changing the height of the box  implies then that thecontents of the box are placed at a different height.Consider as an example\Ver>\hbox{a\setbox0=\vbox{\hbox{b}}\box0 c}<Revwhich gives\disp\leavevmode\hbox{a\setbox0=\vbox{\hbox{b}}\box0 c}\dispstopand\Ver>\hbox{a\setbox0=\vbox{\hbox{b}}\ht0=0cm \box0 c}<Rev\awpwhich gives\disp\leavevmode\hbox{a\setbox0=\vbox{\hbox{b}}\ht0=0cm \box0 c}\>By contrast, changing the width of a box placed in verticalmode has no effect on its placement.\spoint More subtleties with vertical boxesSince there are two kinds of vertical boxes, the \cs{vbox} andthe \cs{vtop}, using these two kinds nested may lead toconfusing results. For instance, \Ver>\vtop{\vbox{...}}<Revis completely equivalent to just \Ver>\vbox{...}<RevIt was stated above thatthe depth of a \cs{vbox} is zero if the last itemis a kern or  glue, and the height of a \cs{vtop} iszero unless the first item in it is a box.The above examples used a kern for that first or last item, but if, in the case of a \cs{vtop}, this item is not a glue or kern, one is apt tooverlook the effect that it has on the surrounding box.For instance,\Ver>\vtop{\write16{...}...}<Rev has zero height,because the write instructionis packed into a `whatsit' item that is placed on the current,that is, the vertical, list. The remedy here is\Ver>\vtop{\leavevmode\write16{...}...}<Revwhich puts the whatsit in the beginning of the paragraph,instead of above it.Placement of items in a vertical list is sometimesa bit tricky. There is for instance a difference betweenhow vertical and horizontal boxes are treated in avertical list. Consider the following examples.After \cs{offinterlineskip} the first example\Ver>\vbox{\hbox{a}      \setbox0=\vbox{\hbox{(}}      \ht0=0pt \dp0=0pt \box0      \hbox{ b}}<Revgives \disp\offinterlineskip\leavevmode\vbox{\hbox{a}      \setbox0=\vbox{\hbox{(}}      \ht0=0pt \dp0=0pt \box0      \hbox{ b}}\dispstopwhile a slight variant\Ver>\vbox{\hbox{a}      \setbox0=\hbox{(}      \ht0=0pt \dp0=0pt \box0      \hbox{ b}}<Rev\awp gives\disp\offinterlineskip\leavevmode\vbox{\hbox{a}      \setbox0=\hbox{(}      \ht0=0pt \dp0=0pt      \box0      \hbox{ b}}\dispstopThe difference is caused by the fact that horizontal boxesare placed with respect to their reference point, but verticalboxes with respect to their upper left corner.\spoint Hanging the \cs{lastbox} back in the listYou can pick the last box off a vertical list that has beencompiled in (internal) vertical mode.However, if you try to hang it back in the list the verticalspacing may go haywire. If you just hang it back, \Ver>\setbox\tmpbox=\lastbox\usethetmpbox \box\tmpbox<Revbaselineskip glue is added a second time. If you `unskip' priorto hanging the box back, \Ver>\setbox\tmpbox=\lastbox \unskip\usethetmpbox \box\tmpbox<Revthings go wrong in a more subtle way.The \gram{internal dimen} \cs{prevdepth} (which controls interline glue; see Chapter~\ref[baseline])will have avalue based on the last box, but what you need for the properinterline glue is a depth based on one box earlier.The solution is not to unskip, but to specify \cs{nointerlineskip}:\Ver>\setbox\tmpbox=\lastbox\usethetmpbox \nointerlineskip \box\tmpbox<Rev\spoint[varioset] Dissecting paragraphs with \cs{lastbox}Repeatedly applying \cs{last...} and \cs{un...} macros\howto Take a paragraph apart\parcan be used to take a paragraph apart.Here is an example of that.\indent\vbox{\message{Check vario look!}\hyphenpenalty10000 \exhyphenpenalty10000 \Indent:no \advance\hsize by -2\parindent\newif\ifsnap \spaceskip=\fontdimen2\font plus \fontdimen3\font\def\eatlines{    \setbox2\lastbox    % check the last line    \ifvoid2\global\snaptrue    \else                      % if it's not empty    \unskip\unpenalty          % take whatever is    {\eatlines}                % above it;    \setbox4\hbox{\unhcopy2}   % collapse this line    \ifdim\wd4<.98\wd2 % if the difference is too large,        \ifsnap \box2 \global\snapfalse        \else \box4 \global\snaptrue         \fi    \else \box2 \global\snapfalse    \fi    \fi}In typesetting advertisement copy, a way of justifyingparagraphs has become popular in recent yearsthat is somewhere between flushright and raggedrightsetting.Lines that would stretch beyond certain limitsare set with their glue at natural width. This paragraphexemplifies this procedure; the macrosfollow next.\par\eatlines}\par\Ver>\newbox\linebox \newbox\snapbox\def\eatlines{    \setbox\linebox\lastbox    % check the last line    \ifvoid\linebox    \else                      % if it's not empty    \unskip\unpenalty          % take whatever is    {\eatlines}                % above it;                               % collapse the line    \setbox\snapbox\hbox{\unhcopy\linebox}                        % depending on the difference    \ifdim\wd\snapbox<.98\wd\linebox          \box\snapbox % take the one or the other,    \else \box\linebox \fi    \fi}<RevThis macro can be called as\Ver>\vbox{ ... some text ... \par\eatlines}<Revor it can be inserted automaticallywith \cs{everypar}; see~\cite[E1].In the macro \cs{eatlines}, the \cs{lastbox} is takenfrom a vertical list. If the list is emptythe last box will test true on \cs{ifvoid}.These boxes containing lines from a paragraphare actually horizontal boxes: the test\cs{ifhbox} applied to them would give a trueresult.\endinput